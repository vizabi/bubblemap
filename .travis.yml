language: node_js
dist: trusty
sudo: true
node_js:
- 8
addons:
  apt:
    packages:
    - python-pip
notifications:
  email: false
  slack:
    rooms:
    - gapminder:siB4Z9ymsYR6qHnRPpgUoB2Q#vizabi-spam
    on_success: change
    on_failure: always
cache:
  directories:
  - node_modules
before_install:
- ssh-keyscan -H $TOOLSPAGE_HOST 2>&1 | tee -a $HOME/.ssh/known_hosts
- openssl aes-256-cbc -K $encrypted_2c6a01adcbe6_key -iv $encrypted_2c6a01adcbe6_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- ssh-add /tmp/deploy_rsa
- npm install -g npm@latest
- sudo pip install s3cmd
before_script:
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
- npm run build
script:
- npm run deploy
deploy:
- provider: npm
  skip_cleanup: true
  email: konzeptmeister@gmail.com
  api_key:
    secure: jGXFiwTwnZmUj8y0dw2dFz6h+K3RQwkE2lHT8VzlOD5RdKR1HXbt+k89BPNdELX0xrOzUQIlELXPcKTL/n1sV24oCNpVtoelfeSp6h6v6lBl27nDOm+csds14eZcKAfbjnrK3lQmDudjRAfXSZbZ/+lbhFJYc6uxKQ41WLYxhxax0TtV4mKkesTia6g7kiCDQDD65VzQNkWZsmendP0gIVGGn4Mj6gPsT8v1bkzygaIX01+dkkEexjAa7YTdm/kx72xrM+oem0N6Evf7VH7Uc0WopQZNHPh4CUnkq0w/f8T0C7rM47zsG1FZ2q343SawILe/DAtoA7Z2Rkf+9RTcXrzn+BPqKXXE1zLQz7HYd/t0CeS5HK4sDZ4vp4fb4p5YJHzGM0V5iD0eTpnH18WVxBHBTMZJnqRYBIX7FQrZ97UJ31AELUKUNlUjLLK/b1g0Qd8nAZmS6aPBFXU4vte5Kk9/1xCnAREEMVa5GpNmtMhCdtmvP2yulh0pXzT8nXjogzZ3fAng0VpgZmOMu6mPoa4JGFrq65luZYboJV6iq3Vw8hx1QhDQoB6gUQVH2tWcBxjwhHlZ4P1CBsQrCNYa5WJyZCJ0HuSwj9vXc0OnB0Nenk8mBxmiYV6XOhb1vXSqiGSDxlbV3HCP0p5wxwxRTK9drTVrobnNezAe1heCXHY=
  on:
    branch: develop
    node: 8
    condition: "-e /tmp/deployment.flag"
- provider: script
  skip_cleanup: true
  script: ssh $TOOLSPAGE_USER@$TOOLSPAGE_HOST 'sh /home/root/redeploy.sh "$TRAVIS_REPO_SLUG"'
  on:
    branch: develop
